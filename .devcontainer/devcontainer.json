{
  // =============================================================================
  // Signal Fish Client SDK - Dev Container Configuration
  // =============================================================================
  // Production-ready Rust development environment
  // Base: mcr.microsoft.com/devcontainers/rust:1-bookworm
  // =============================================================================

  "name": "Signal Fish Client SDK",
  "build": {
    "dockerfile": "Dockerfile",
    "context": ".."
  },

  // Pass --init so that PID 1 is a proper init process (prevents zombie processes
  // from accumulating when child processes terminate unexpectedly).
  "runArgs": ["--init"],

  // =============================================================================
  // Container Settings
  // =============================================================================

  "remoteUser": "vscode",
  "workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",

  // =============================================================================
  // Volume Mounts
  // =============================================================================

  "mounts": [
    // Cargo registry cache - speeds up dependency downloads
    "source=signal-fish-cargo-registry,target=/home/vscode/.cargo/registry,type=volume",
    // Cargo git cache - speeds up git dependencies
    "source=signal-fish-cargo-git,target=/home/vscode/.cargo/git,type=volume",
    // Target directory cache - speeds up incremental builds
    "source=signal-fish-target-${localWorkspaceFolderBasename},target=/workspaces/${localWorkspaceFolderBasename}/target,type=volume",
    // Mount SSH keys from host (read-only)
    "source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh,type=bind,readonly",
    // Mount git config from host (read-only)
    "source=${localEnv:HOME}/.gitconfig,target=/home/vscode/.gitconfig,type=bind,readonly",
    // Mount GPG for commit signing (read-only for security)
    // For active signing, use gpg-agent forwarding or SSH signing instead
    // See .devcontainer/README.md for configuration options
    "source=${localEnv:HOME}/.gnupg,target=/home/vscode/.gnupg,type=bind,readonly"
  ],

  // =============================================================================
  // Environment Variables
  // =============================================================================

  "containerEnv": {
    // Rust debugging
    "RUST_BACKTRACE": "1",
    
    // Cargo configuration
    "CARGO_TERM_COLOR": "always",
    
    // Terminal colors
    "TERM": "xterm-256color",
    "COLORTERM": "truecolor"
    
    // Delta theme: set COLORSCHEME to "light" if using a light VS Code theme.
    // This affects git diff display. Default assumes dark theme.
    // Uncomment to override: "COLORSCHEME": "light"
  },

  // =============================================================================
  // Remote Environment Variables (container-side, injected by VS Code)
  // =============================================================================

  "remoteEnv": {
    // Promote the workspace folder from a JSON substitution into a real shell
    // environment variable accessible in lifecycle scripts (postStartCommand, etc.).
    // ${containerWorkspaceFolder} is resolved at container configuration time by
    // the devcontainer runtime, but it is NOT automatically exported as a shell
    // variable. Declaring it here in remoteEnv makes it available as $CONTAINER_WORKSPACE_FOLDER
    // inside bash scripts without any extra plumbing.
    "CONTAINER_WORKSPACE_FOLDER": "${containerWorkspaceFolder}"
  },

  // =============================================================================
  // VS Code Customizations
  // =============================================================================

  "customizations": {
    "vscode": {
      // =========================================================================
      // Extensions
      // =========================================================================
      "extensions": [
        // Rust Development
        "rust-lang.rust-analyzer",
        "serayuzgur.crates",
        "tamasfe.even-better-toml",
        "vadimcn.vscode-lldb",

        // GitHub Integration
        "GitHub.vscode-pull-request-github",
        "GitHub.vscode-github-actions",
        "GitHub.copilot",
        "GitHub.copilot-chat",

        // AI Assistants
        "Anthropic.claude-code",          // Official Anthropic Claude Code extension
        "saoudrizwan.claude-dev",          // Cline (community extension, formerly Claude Dev)

        // Code Quality & Visualization
        "usernamehw.errorlens",
        "eamodio.gitlens",
        "Gruntfuggly.todo-tree",
        "aaron-bond.better-comments",
        "oderwat.indent-rainbow",
        "christian-kohler.path-intellisense",

        // Productivity & Documentation
        "streetsidesoftware.code-spell-checker",
        "DavidAnson.vscode-markdownlint",
        "redhat.vscode-yaml",
        "rangav.vscode-thunder-client",

        // Docker
        "ms-azuretools.vscode-docker",

        // WebSocket Testing (useful for signaling client development)
        "nickmomrik.websocket-client"
      ],

      // =========================================================================
      // VS Code Settings
      // =========================================================================
      "settings": {
        // -----------------------------------------------------------------------
        // Editor Settings
        // -----------------------------------------------------------------------
        "editor.formatOnSave": true,
        "editor.tabSize": 4,
        "editor.insertSpaces": true,
        "editor.rulers": [100],
        "editor.bracketPairColorization.enabled": true,
        "editor.guides.bracketPairs": "active",
        "editor.inlayHints.enabled": "onUnlessPressed",
        "editor.semanticHighlighting.enabled": true,

        // -----------------------------------------------------------------------
        // Terminal Settings
        // -----------------------------------------------------------------------
        "terminal.integrated.defaultProfile.linux": "bash",
        "terminal.integrated.scrollback": 10000,

        // -----------------------------------------------------------------------
        // File Settings
        // -----------------------------------------------------------------------
        "files.trimTrailingWhitespace": true,
        "files.insertFinalNewline": true,
        "files.trimFinalNewlines": true,
        "files.watcherExclude": {
          "**/target/**": true
        },

        // -----------------------------------------------------------------------
        // Search Settings
        // -----------------------------------------------------------------------
        "search.exclude": {
          "**/target": true,
          "**/Cargo.lock": true
        },

        // -----------------------------------------------------------------------
        // Rust-Analyzer Settings
        // -----------------------------------------------------------------------
        "[rust]": {
          "editor.defaultFormatter": "rust-lang.rust-analyzer",
          "editor.formatOnSave": true
        },

        // Enable all features for complete analysis
        "rust-analyzer.cargo.features": ["all"],

        // Check on save with clippy
        "rust-analyzer.check.command": "clippy",
        "rust-analyzer.check.extraArgs": ["--all-targets", "--all-features"],

        // Inlay hints configuration
        "rust-analyzer.inlayHints.typeHints.enable": true,
        "rust-analyzer.inlayHints.parameterHints.enable": true,
        "rust-analyzer.inlayHints.chainingHints.enable": true,
        "rust-analyzer.inlayHints.closingBraceHints.enable": true,
        "rust-analyzer.inlayHints.lifetimeElisionHints.enable": "skip_trivial",

        // Proc macro support
        "rust-analyzer.procMacro.enable": true,
        "rust-analyzer.procMacro.attributes.enable": true,

        // Cargo settings
        "rust-analyzer.cargo.buildScripts.enable": true,
        "rust-analyzer.cargo.autoreload": true,

        // Completion settings
        "rust-analyzer.completion.autoimport.enable": true,
        "rust-analyzer.completion.postfix.enable": true,

        // Diagnostics
        "rust-analyzer.diagnostics.enable": true,
        "rust-analyzer.diagnostics.experimental.enable": true,

        // -----------------------------------------------------------------------
        // LLDB Debugger Settings
        // -----------------------------------------------------------------------
        "lldb.showDisassembly": "never",
        "lldb.dereferencePointers": true,

        // -----------------------------------------------------------------------
        // Git Settings
        // -----------------------------------------------------------------------
        "git.autofetch": true,
        "git.confirmSync": false,

        // -----------------------------------------------------------------------
        // GitLens Settings
        // -----------------------------------------------------------------------
        "gitlens.codeLens.enabled": true,
        "gitlens.currentLine.enabled": true,

        // -----------------------------------------------------------------------
        // Error Lens Settings
        // -----------------------------------------------------------------------
        "errorLens.enabledDiagnosticLevels": ["error", "warning", "hint"],
        "errorLens.delay": 500,

        // -----------------------------------------------------------------------
        // Todo Tree Settings
        // -----------------------------------------------------------------------
        "todo-tree.general.tags": [
          "TODO",
          "FIXME",
          "BUG",
          "HACK",
          "XXX",
          "PERF",
          "NOTE",
          "SAFETY"
        ],

        // -----------------------------------------------------------------------
        // Spell Checker Settings
        // -----------------------------------------------------------------------
        "cSpell.words": [
          "rustfmt",
          "clippy",
          "nextest",
          "tarpaulin",
          "tokio",
          "serde",
          "thiserror",
          "tracing",
          "uuid",
          "websocket",
          "signalfish",
          "SignalFish",
          "devcontainer",
          "bookworm",
          "zmij",
          "batcat",
          "fdfind",
          "ripgrep",
          "mold"
        ]
      }
    }
  },

  // =============================================================================
  // Lifecycle Scripts
  // =============================================================================

  // Gracefully create host directories if they don't exist (runs on host before container starts)
  "initializeCommand": "mkdir -p ~/.ssh ~/.gnupg 2>/dev/null || true; touch ~/.gitconfig 2>/dev/null || true; echo 'Prerequisites checked'",
  "postCreateCommand": "if cargo fetch; then echo 'cargo fetch complete'; else echo 'WARNING: cargo fetch failed (continuing)'; fi; echo 'Signal Fish Client SDK dev container ready!'",
  // Runs on every container start. See .devcontainer/scripts/post-start.sh for details.
  "postStartCommand": "bash .devcontainer/scripts/post-start.sh",
  "postAttachCommand": "echo 'Welcome to Signal Fish Client SDK development environment!'",

  // =============================================================================
  // Additional Options
  // =============================================================================

  "shutdownAction": "stopContainer"
}
