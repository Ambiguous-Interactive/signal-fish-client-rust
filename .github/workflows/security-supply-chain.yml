# Security & supply-chain pipeline for signal-fish-client
#
# Runs on every push to main, on all pull requests, and on a weekday
# schedule for ongoing monitoring.
#
# Jobs:
#   cargo-audit — vulnerability advisory check (PR/push + schedule)
#   cargo-deny  — license & advisory audit (schedule only; ci.yml covers PR/push)
#   sbom        — generate CycloneDX SBOM artifact (PR/push + schedule)
#
# Cancel in-progress runs on the same branch to save resources.
# The concurrency group includes the event name so push and scheduled runs
# on the same ref do not cancel each other.

name: Security

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    # Weekdays at 06:00 UTC — avoids weekend noise
    - cron: "0 6 * * 1-5"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  # ──────────────────────────────────────────────────────────────
  # cargo-audit — check for known security vulnerabilities
  #
  # Cargo.lock is not committed (library crate convention), so we
  # generate a fresh lockfile before auditing.
  # ──────────────────────────────────────────────────────────────
  cargo-audit:
    name: cargo-audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Generate lockfile
        run: cargo generate-lockfile

      - name: Install cargo-audit
        uses: taiki-e/install-action@cfdb446e391c69574ebc316dfb7d7849ec12b940  # v2
        with:
          tool: cargo-audit

      - name: Run cargo audit
        run: cargo audit

  # ──────────────────────────────────────────────────────────────
  # cargo-deny — license and advisory audit (scheduled only)
  #
  # ci.yml already runs cargo-deny on push/PR. This job provides
  # ongoing scheduled monitoring so new advisories are caught even
  # when no code changes are being made.
  # ──────────────────────────────────────────────────────────────
  cargo-deny:
    name: cargo-deny (scheduled)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979  # v2

  # ──────────────────────────────────────────────────────────────
  # SBOM — generate CycloneDX Software Bill of Materials
  #
  # Cargo.lock is not committed (library crate convention), so we
  # generate a fresh lockfile before building the SBOM.
  # ──────────────────────────────────────────────────────────────
  sbom:
    name: SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2

      - name: Generate lockfile
        run: cargo generate-lockfile

      - name: Install cargo-cyclonedx
        uses: taiki-e/install-action@cfdb446e391c69574ebc316dfb7d7849ec12b940  # v2
        with:
          tool: cargo-cyclonedx

      - name: Generate CycloneDX SBOM
        run: cargo cyclonedx --format json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: sbom-cyclonedx-${{ github.sha }}-${{ github.run_number }}
          path: ./**/*.cdx.json
          if-no-files-found: error
          retention-days: 90
