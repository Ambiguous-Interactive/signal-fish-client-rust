# Release workflow for signal-fish-client
#
# Publishes the crate to crates.io and creates a GitHub Release.
# Triggers: manual dispatch (workflow_dispatch) or pushing a v* tag.

name: Release - Publish Crate

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Version to publish (must match Cargo.toml)"
        required: true
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # Never cancel an in-progress publish â€” partial releases are hard to recover from
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # Deny warnings in CI for doc builds
  RUSTDOCFLAGS: "-D warnings"

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: crates-io
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.actor != 'github-actions[bot]')

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Validate release_version format
        if: github.event_name == 'workflow_dispatch'
        env:
          INPUT_VERSION: ${{ github.event.inputs.release_version }}
        run: |
          if ! echo "$INPUT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
            echo "::error::Invalid semver format: '$INPUT_VERSION'. Expected format: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]"
            exit 1
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Configure sccache
        id: sccache
        uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad  # v0.0.9
        continue-on-error: true

      - name: Verify sccache is working
        id: sccache-check
        if: steps.sccache.outcome == 'success'
        run: ./scripts/verify-sccache.sh
        continue-on-error: true

      - name: Clear sccache env on failure
        if: steps.sccache.outcome != 'success' || steps.sccache-check.outcome != 'success'
        run: |
          echo "RUSTC_WRAPPER=" >> "$GITHUB_ENV"
          echo "SCCACHE_GHA_ENABLED=" >> "$GITHUB_ENV"

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2

      - name: Verify version matches tag (if tag push)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          if [ "$TAG_VERSION" != "v${CARGO_VERSION}" ]; then
            echo "Tag version $TAG_VERSION does not match Cargo.toml version $CARGO_VERSION" >&2
            exit 1
          fi

      - name: Verify version matches input (if manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        env:
          INPUT_VERSION: ${{ github.event.inputs.release_version }}
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          if [ "$INPUT_VERSION" != "$CARGO_VERSION" ]; then
            echo "Input version $INPUT_VERSION does not match Cargo.toml version $CARGO_VERSION" >&2
            exit 1
          fi

      - name: Run fmt check
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        env:
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.working == 'true' && 'sccache' || '' }}
          SCCACHE_GHA_ENABLED: ${{ steps.sccache-check.outputs.working == 'true' && 'true' || 'false' }}
          SCCACHE_IGNORE_SERVER_IO_ERROR: "1"
          SCCACHE_STARTUP_NOTIFY_TIMEOUT: "60"
          SCCACHE_IDLE_TIMEOUT: "0"

      - name: Run tests
        run: cargo test --all-features
        env:
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.working == 'true' && 'sccache' || '' }}
          SCCACHE_GHA_ENABLED: ${{ steps.sccache-check.outputs.working == 'true' && 'true' || 'false' }}
          SCCACHE_IGNORE_SERVER_IO_ERROR: "1"
          SCCACHE_STARTUP_NOTIFY_TIMEOUT: "60"
          SCCACHE_IDLE_TIMEOUT: "0"

      - name: Publish (dry-run)
        run: cargo publish --dry-run
        env:
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.working == 'true' && 'sccache' || '' }}
          SCCACHE_GHA_ENABLED: ${{ steps.sccache-check.outputs.working == 'true' && 'true' || 'false' }}
          SCCACHE_IGNORE_SERVER_IO_ERROR: "1"
          SCCACHE_STARTUP_NOTIFY_TIMEOUT: "60"
          SCCACHE_IDLE_TIMEOUT: "0"

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.working == 'true' && 'sccache' || '' }}
          SCCACHE_GHA_ENABLED: ${{ steps.sccache-check.outputs.working == 'true' && 'true' || 'false' }}
          SCCACHE_IGNORE_SERVER_IO_ERROR: "1"
          SCCACHE_STARTUP_NOTIFY_TIMEOUT: "60"
          SCCACHE_IDLE_TIMEOUT: "0"
        run: cargo publish

      - name: Create and push git tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          TAG_NAME="v${CARGO_VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Get version for release
        id: get_version
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            VERSION=$(grep '^version = ' Cargo.toml | head -n1 | cut -d '"' -f2)
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog for release
        id: changelog
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          CHANGELOG_CONTENT=""
          if [ -f CHANGELOG.md ]; then
            CHANGELOG_CONTENT=$(awk -v ver="$VERSION" '
              BEGIN { printing=0 }
              /^## \[/ {
                if (printing) { exit }
                if (index($0, "[" ver "]") > 0) { printing=1; next }
              }
              printing { print }
            ' CHANGELOG.md)
          fi

          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="Release $VERSION"
          fi

          printf '%s\n' "$CHANGELOG_CONTENT" > "$RUNNER_TEMP/release_notes.md"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: ${{ steps.get_version.outputs.tag }}
          body_path: ${{ runner.temp }}/release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
