# CI pipeline for signal-fish-client
#
# Runs on every push to main and on all pull requests.
# Jobs: fmt → clippy, test, msrv, doc, deny → publish-dry-run
#
# Cancel in-progress runs on the same branch to save resources.

name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # Deny warnings in CI for doc builds
  RUSTDOCFLAGS: "-D warnings"

jobs:
  # ──────────────────────────────────────────────────────────────
  # Formatting — fastest check, runs first
  # ──────────────────────────────────────────────────────────────
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  # ──────────────────────────────────────────────────────────────
  # Clippy — lint check across feature combinations
  # ──────────────────────────────────────────────────────────────
  clippy:
    name: Clippy (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: fmt
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            flags: ""
          - name: all-features
            flags: "--all-features"
          - name: no-default-features
            flags: "--no-default-features"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets ${{ matrix.flags }} -- -D warnings

  # ──────────────────────────────────────────────────────────────
  # Tests — run across feature combinations
  # ──────────────────────────────────────────────────────────────
  test:
    name: Test (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: fmt
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            flags: ""
          - name: all-features
            flags: "--all-features"
          - name: no-default-features
            flags: "--no-default-features"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test ${{ matrix.flags }}

  # ──────────────────────────────────────────────────────────────
  # MSRV — verify minimum supported Rust version (1.75.0)
  # ──────────────────────────────────────────────────────────────
  msrv:
    name: MSRV (1.75.0)
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.75.0
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --all-features
      - run: cargo test --all-features

  # ──────────────────────────────────────────────────────────────
  # Documentation — ensure docs build cleanly
  # ──────────────────────────────────────────────────────────────
  doc:
    name: Documentation
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --all-features --no-deps

  # ──────────────────────────────────────────────────────────────
  # cargo-deny — license and advisory audit
  # ──────────────────────────────────────────────────────────────
  deny:
    name: cargo-deny
    runs-on: ubuntu-latest
    needs: fmt
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2

  # ──────────────────────────────────────────────────────────────
  # Publish dry-run — verify crate packages correctly
  # Depends on tests and clippy passing first.
  # ──────────────────────────────────────────────────────────────
  publish-dry-run:
    name: Publish dry-run
    runs-on: ubuntu-latest
    needs: [clippy, test, msrv, doc, deny]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo publish --dry-run
