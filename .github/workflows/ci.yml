# CI pipeline for signal-fish-client
#
# Runs on every push to main and on all pull requests.
# Jobs: fmt → clippy, test, msrv, doc, deny → publish-dry-run
#
# Cancel in-progress runs on the same branch to save resources.

name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  # Deny warnings in CI for doc builds
  RUSTDOCFLAGS: "-D warnings"

jobs:
  # ──────────────────────────────────────────────────────────────
  # Formatting — fastest check, runs first
  # ──────────────────────────────────────────────────────────────
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --check

  # ──────────────────────────────────────────────────────────────
  # Clippy — lint check across feature combinations
  # ──────────────────────────────────────────────────────────────
  clippy:
    name: Clippy (${{ matrix.name }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: fmt
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            flags: ""
          - name: all-features
            flags: "--all-features"
          - name: no-default-features
            flags: "--no-default-features"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
      - name: Run Clippy
        run: cargo clippy --all-targets ${{ matrix.flags }} -- -D warnings

  # ──────────────────────────────────────────────────────────────
  # Tests — run across feature combinations
  # ──────────────────────────────────────────────────────────────
  test:
    name: Test (${{ matrix.name }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: fmt
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            flags: ""
          - name: all-features
            flags: "--all-features"
          - name: no-default-features
            flags: "--no-default-features"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test ${{ matrix.flags }}

  # ──────────────────────────────────────────────────────────────
  # MSRV — verify minimum supported Rust version (1.85.0)
  # ──────────────────────────────────────────────────────────────
  msrv:
    name: MSRV (1.85.0)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
      - name: Generate lockfile
        run: cargo generate-lockfile
      - name: Build with MSRV
        run: cargo build --locked --all-features
      - name: Test with MSRV
        run: cargo test --locked --all-features

  # ──────────────────────────────────────────────────────────────
  # Documentation — ensure docs build cleanly
  # ──────────────────────────────────────────────────────────────
  doc:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
      - name: Build documentation
        run: cargo doc --all-features --no-deps
      - name: Install nightly toolchain
        run: rustup toolchain install nightly --profile minimal
      - name: Verify docs.rs compatibility
        run: bash scripts/check-docsrs.sh

  # ──────────────────────────────────────────────────────────────
  # cargo-deny — license and advisory audit
  # ──────────────────────────────────────────────────────────────
  deny:
    name: cargo-deny
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: fmt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@v2

  # ──────────────────────────────────────────────────────────────
  # Publish dry-run — verify crate packages correctly
  # Depends on tests and clippy passing first.
  # ──────────────────────────────────────────────────────────────
  publish-dry-run:
    name: Publish dry-run
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [clippy, test, msrv, doc, deny]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@v2
      - name: Run publish dry-run
        run: cargo publish --dry-run
