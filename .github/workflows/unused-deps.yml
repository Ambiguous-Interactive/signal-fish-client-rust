# Unused dependency checks for signal-fish-client
#
# Keeps the dependency tree minimal by catching unused crates early.
#
# Jobs:
#   cargo-machete — fast heuristic-based unused dep detector (PR/push)
#   cargo-udeps   — thorough nightly-only analysis (schedule only)
#
# Cancel in-progress runs on the same branch to save resources.
# The concurrency group includes the event name so push and scheduled runs
# on the same ref do not cancel each other.

name: Unused Deps

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    # Weekdays at 05:00 UTC — staggered from security workflow at 06:00
    - cron: "0 5 * * 1-5"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  # ──────────────────────────────────────────────────────────────
  # cargo-machete — fast heuristic scan for unused dependencies
  #
  # Runs on every PR and push to main. Lightweight enough to be a
  # required status check on pull requests.
  #
  # Note: cargo-machete uses heuristic source-code scanning (grepping
  # for `use <crate>` statements), not build-based analysis, so it
  # does not need a lockfile — unlike cargo-audit or cargo-udeps.
  # ──────────────────────────────────────────────────────────────
  cargo-machete:
    name: cargo-machete
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2

      - name: Install cargo-machete
        uses: taiki-e/install-action@470679bc3a1580072dac4e67535d1aa3a3dcdf51  # v2
        with:
          tool: cargo-machete

      - name: Run cargo machete
        run: cargo machete

  # ──────────────────────────────────────────────────────────────
  # cargo-udeps — thorough unused dependency analysis (scheduled)
  #
  # Requires the nightly toolchain and a full build, so it runs on
  # a weekday schedule only. Cargo.lock is not committed (library
  # crate convention), so we generate a fresh lockfile first.
  # Promote to PR-required once stable.
  # ──────────────────────────────────────────────────────────────
  cargo-udeps:
    name: cargo-udeps (scheduled)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Cargo artifacts
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2

      - name: Generate lockfile
        run: cargo generate-lockfile

      - name: Install cargo-udeps
        uses: taiki-e/install-action@470679bc3a1580072dac4e67535d1aa3a3dcdf51  # v2
        with:
          tool: cargo-udeps

      - name: Run cargo udeps
        run: cargo +nightly udeps --all-targets --all-features
